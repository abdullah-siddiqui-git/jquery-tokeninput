/*! jquery.tokeninput 2014-04-02 */
!function(t){var e={method:"GET",queryParam:"q",searchDelay:300,minChars:1,propertyToSearch:"name",jsonContainer:null,contentType:"json",excludeCurrent:!1,excludeCurrentParameter:"x",prePopulate:null,processPrePopulate:!1,hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&#215;",animateDropdown:!0,placeholder:null,theme:null,zindex:999,resultsLimit:null,enableHTML:!1,resultsFormatter:function(t){var e=t[this.propertyToSearch];return"<li>"+(this.enableHTML?e:k(e))+"</li>"},tokenFormatter:function(t){var e=t[this.propertyToSearch];return"<li><p>"+(this.enableHTML?e:k(e))+"</p></li>"},tokenLimit:null,tokenDelimiter:",",preventDuplicates:!1,tokenValue:"id",allowFreeTagging:!1,allowTabOut:!1,autoSelectFirstResult:!1,onResult:null,onCachedResult:null,onAdd:null,onFreeTaggingAdd:null,onDelete:null,onReady:null,idPrefix:"token-input-",disabled:!1},n={tokenList:"token-input-list",token:"token-input-token",tokenReadOnly:"token-input-token-readonly",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token",focused:"token-input-focused",disabled:"token-input-disabled"},a={BEFORE:0,AFTER:1,END:2},s=8,i=9,o=13,l=27,d=37,r=38,u=39,c=40,g=108,p=188,h={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"},f=/[&<>"'\/]/g;function k(t){return(e=t,String(null==e?"":e)).replace(f,function(t){return h[t]});var e}var m={init:function(n,a){var s=t.extend({},e,a||{});return this.each(function(){t(this).data("settings",s),t(this).data("tokenInputObject",new t.TokenList(this,n,s))})},clear:function(){return this.data("tokenInputObject").clear(),this},add:function(t){return this.data("tokenInputObject").add(t),this},remove:function(t){return this.data("tokenInputObject").remove(t),this},get:function(){return this.data("tokenInputObject").getTokens()},toggleDisabled:function(t){return this.data("tokenInputObject").toggleDisabled(t),this},setOptions:function(e){return t(this).data("settings",t.extend({},t(this).data("settings"),e||{})),this},destroy:function(){if(this.data("tokenInputObject")){this.data("tokenInputObject").clear();var t=this.parent();return t.empty(),this.show(),t.append(this),this}}};t.fn.tokenInput=function(t){return m[t]?m[t].apply(this,Array.prototype.slice.call(arguments,1)):m.init.apply(this,arguments)},t.TokenList=function(e,h,f){if("string"==typeof h||"function"==typeof h){t(e).data("settings").url=h;var m=Y();void 0===t(e).data("settings").crossDomain&&"string"==typeof m&&(-1===m.indexOf("://")?t(e).data("settings").crossDomain=!1:t(e).data("settings").crossDomain=location.href.split(/\/+/g)[1]!==m.split(/\/+/g)[1])}else"object"==typeof h&&(t(e).data("settings").local_data=h);t(e).data("settings").classes?t(e).data("settings").classes=t.extend({},n,t(e).data("settings").classes):t(e).data("settings").theme?(t(e).data("settings").classes={},t.each(n,function(n,a){t(e).data("settings").classes[n]=a+"-"+t(e).data("settings").theme})):t(e).data("settings").classes=n;var v,T,y=[],b=0,w=new t.TokenList.Cache,C=t('<input type="text" autocomplete="off" autocapitalize="off"/>').css({outline:"none"}).attr("id",t(e).data("settings").idPrefix+e.id).focus(function(){if(t(e).data("settings").disabled)return!1;null!==t(e).data("settings").tokenLimit&&t(e).data("settings").tokenLimit===b||t(e).data("settings").hintText&&(O.html("<p>"+I(t(e).data("settings").hintText)+"</p>"),$()),L.addClass(t(e).data("settings").classes.focused)}).blur(function(){W(),t(e).data("settings").allowFreeTagging&&z(),t(this).val(""),L.removeClass(t(e).data("settings").classes.focused)}).bind("keyup keydown blur update",V).keydown(function(n){var h,f;switch(n.keyCode){case d:case u:case r:case c:if(0===this.value.length)h=j.prev(),f=j.next(),h.length&&h.get(0)===D||f.length&&f.get(0)===D?n.keyCode===d||n.keyCode===r?H(t(D),a.BEFORE):H(t(D),a.AFTER):n.keyCode!==d&&n.keyCode!==r||!h.length?n.keyCode!==u&&n.keyCode!==c||!f.length||N(t(f.get(0))):N(t(h.get(0)));else{var k=null;n.keyCode===c||n.keyCode===u?(k=t(O).find("li").first(),R&&(k=t(R).next())):(k=t(O).find("li").last(),R&&(k=t(R).prev())),U(k)}break;case s:if(h=j.prev(),0===this.value.length)return D?(_(t(D)),x.change()):h.length&&N(t(h.get(0))),!1;1===t(this).val().length?W():setTimeout(function(){X()},5);break;case i:case o:case g:case p:if(R)M(t(R).data("tokeninput")),x.change();else{if(t(e).data("settings").allowFreeTagging){if(t(e).data("settings").allowTabOut&&""===t(this).val())return!0;z()}else if(t(this).val(""),t(e).data("settings").allowTabOut)return!0;n.stopPropagation(),n.preventDefault()}return!1;case l:return W(),!0;default:String.fromCharCode(n.which)&&setTimeout(function(){X()},5)}});f.placeholder&&C.attr("placeholder",f.placeholder);var x=t(e).hide().val("").focus(function(){Z(C)}).blur(function(){return C.blur(),x}),D=null,F=0,R=null,L=t("<ul />").addClass(t(e).data("settings").classes.tokenList).click(function(e){var n=t(e.target).closest("li");n&&n.get(0)&&t.data(n.get(0),"tokeninput")?function(e){var n=D;D&&H(t(D),a.END);n===e.get(0)?H(e,a.END):N(e)}(n):(D&&H(t(D),a.END),Z(C))}).mouseover(function(n){var a=t(n.target).closest("li");a&&D!==this&&a.addClass(t(e).data("settings").classes.highlightedToken)}).mouseout(function(n){var a=t(n.target).closest("li");a&&D!==this&&a.removeClass(t(e).data("settings").classes.highlightedToken)}).insertBefore(x),j=t("<li />").addClass(t(e).data("settings").classes.inputToken).appendTo(L).append(C),O=t("<div/>").addClass(t(e).data("settings").classes.dropdown).appendTo("body").hide(),S=t("<tester/>").insertAfter(C).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:C.css("fontSize"),fontFamily:C.css("fontFamily"),fontWeight:C.css("fontWeight"),letterSpacing:C.css("letterSpacing"),whiteSpace:"nowrap"});x.val("");var E=t(e).data("settings").prePopulate||x.data("pre");function I(n){return t(e).data("settings").enableHTML?n:k(n)}function A(n){t(e).data("settings").disabled="boolean"==typeof n?n:!t(e).data("settings").disabled,C.attr("disabled",t(e).data("settings").disabled),L.toggleClass(t(e).data("settings").classes.disabled,t(e).data("settings").disabled),D&&H(t(D),a.END),x.attr("disabled",t(e).data("settings").disabled)}function P(){if(null!==t(e).data("settings").tokenLimit&&b>=t(e).data("settings").tokenLimit)return C.hide(),void W()}function V(){if(T!==(T=C.val())){var t=L.width()-C.offset().left-L.offset().left;S.html(k(T)||k(f.placeholder)),C.width(Math.min(L.width(),Math.max(t,S.width()+30)))}}function z(){var n=t.trim(C.val()).split(t(e).data("settings").tokenDelimiter);t.each(n,function(n,a){if(a){t.isFunction(t(e).data("settings").onFreeTaggingAdd)&&(a=t(e).data("settings").onFreeTaggingAdd.call(x,a));var s={};s[t(e).data("settings").tokenValue]=s[t(e).data("settings").propertyToSearch]=a,M(s)}})}function B(n){var a=t(t(e).data("settings").tokenFormatter(n)),s=!0===n.readonly;s&&a.addClass(t(e).data("settings").classes.tokenReadOnly),a.addClass(t(e).data("settings").classes.token).insertBefore(j),s||t("<span>"+t(e).data("settings").deleteText+"</span>").addClass(t(e).data("settings").classes.tokenDelete).appendTo(a).click(function(){if(!t(e).data("settings").disabled)return _(t(this).parent()),x.change(),!1});var i=n;return t.data(a.get(0),"tokeninput",n),y=y.slice(0,F).concat([i]).concat(y.slice(F)),F++,q(y,x),b+=1,null!==t(e).data("settings").tokenLimit&&b>=t(e).data("settings").tokenLimit&&(C.hide(),W()),a}function M(n){var a=t(e).data("settings").onAdd;if(b>0&&t(e).data("settings").preventDuplicates){var s=null;if(L.children().each(function(){var e=t(this),a=t.data(e.get(0),"tokeninput");if(a&&a[f.tokenValue]===n[f.tokenValue])return s=e,!1}),s)return N(s),j.insertAfter(s),void Z(C)}C.width(1),(null==t(e).data("settings").tokenLimit||b<t(e).data("settings").tokenLimit)&&(B(n),C.attr("placeholder",null),P()),C.val(""),W(),t.isFunction(a)&&a.call(x,n)}function N(n){t(e).data("settings").disabled||(n.addClass(t(e).data("settings").classes.selectedToken),D=n.get(0),C.val(""),W())}function H(n,s){n.removeClass(t(e).data("settings").classes.selectedToken),D=null,s===a.BEFORE?(j.insertBefore(n),F--):s===a.AFTER?(j.insertAfter(n),F++):(j.appendTo(L),F=b),Z(C)}function _(n){var a=t.data(n.get(0),"tokeninput"),s=t(e).data("settings").onDelete,i=n.prevAll().length;i>F&&i--,n.remove(),D=null,Z(C),0==(y=y.slice(0,i).concat(y.slice(i+1))).length&&C.attr("placeholder",f.placeholder),i<F&&F--,q(y,x),b-=1,null!==t(e).data("settings").tokenLimit&&(C.show().val(""),Z(C)),t.isFunction(s)&&s.call(x,a)}function q(n,a){var s=t.map(n,function(n){return"function"==typeof t(e).data("settings").tokenValue?t(e).data("settings").tokenValue.call(this,n):n[t(e).data("settings").tokenValue]});a.val(s.join(t(e).data("settings").tokenDelimiter))}function W(){O.hide().empty(),R=null}function $(){O.css({position:"absolute",top:L.offset().top+L.outerHeight(!0),left:L.offset().left,width:L.width(),"z-index":t(e).data("settings").zindex}).show()}t(e).data("settings").processPrePopulate&&t.isFunction(t(e).data("settings").onResult)&&(E=t(e).data("settings").onResult.call(x,E)),E&&E.length&&t.each(E,function(t,e){B(e),P(),C.attr("placeholder",null)}),t(e).data("settings").disabled&&A(!0),"function"==typeof t(e).data("settings").onReady&&t(e).data("settings").onReady.call(),this.clear=function(){L.children("li").each(function(){0===t(this).children("input").length&&_(t(this))})},this.add=function(t){M(t)},this.remove=function(e){L.children("li").each(function(){if(0===t(this).children("input").length){var n=t(this).data("tokeninput"),a=!0;for(var s in e)if(e[s]!==n[s]){a=!1;break}a&&_(t(this))}})},this.getTokens=function(){return y},this.toggleDisabled=function(t){A(t)},V();var G=new RegExp("[.\\\\+*?\\[\\^\\]$(){}=!<>|:\\-]","g");function Q(t){return t.replace(G,"\\$&")}function J(t,e,n){return t.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+Q(e)+")(?![^<>]*>)(?![^&;]+;)","g"),function(t,e){return t.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+Q(e)+")(?![^<>]*>)(?![^&;]+;)","gi"),function(t,e){return"<b>"+I(e)+"</b>"})}(e,n))}function K(n,a){if((a=function(n){if(t(e).data("settings").excludeCurrent){var a=t(e).data("tokenInputObject").getTokens(),s=[];a.length&&(t.each(n,function(n,i){var o=!0;t.each(a,function(n,a){if(i[t(e).data("settings").propertyToSearch]==a[t(e).data("settings").propertyToSearch])return o=!1,!1}),o&&s.push(i)}),n=s)}return n}(a))&&a.length){O.empty();var s=t("<ul/>").appendTo(O).mouseover(function(e){U(t(e.target).closest("li"))}).mousedown(function(e){return M(t(e.target).closest("li").data("tokeninput")),x.change(),!1}).hide();t(e).data("settings").resultsLimit&&a.length>t(e).data("settings").resultsLimit&&(a=a.slice(0,t(e).data("settings").resultsLimit)),t.each(a,function(a,i){var o=t(e).data("settings").resultsFormatter(i);o=J(o,i[t(e).data("settings").propertyToSearch],n),o=t(o).appendTo(s),a%2?o.addClass(t(e).data("settings").classes.dropdownItem):o.addClass(t(e).data("settings").classes.dropdownItem2),0===a&&t(e).data("settings").autoSelectFirstResult&&U(o),t.data(o.get(0),"tokeninput",i)}),$(),t(e).data("settings").animateDropdown?s.slideDown("fast"):s.show()}else t(e).data("settings").noResultsText&&(O.html("<p>"+I(t(e).data("settings").noResultsText)+"</p>"),$())}function U(n){n&&(R&&function(n){n.removeClass(t(e).data("settings").classes.selectedDropdownItem),R=null}(t(R)),n.addClass(t(e).data("settings").classes.selectedDropdownItem),R=n.get(0))}function X(){var n=C.val();n&&n.length&&(D&&H(t(D),a.AFTER),n.length>=t(e).data("settings").minChars?(t(e).data("settings").searchingText&&(O.html("<p>"+I(t(e).data("settings").searchingText)+"</p>"),$()),clearTimeout(v),v=setTimeout(function(){!function(n){var a=n+Y(),s=w.get(a);if(s)t.isFunction(t(e).data("settings").onCachedResult)&&(s=t(e).data("settings").onCachedResult.call(x,s)),K(n,s);else if(t(e).data("settings").url){var i=Y(),o={data:{}};if(i.indexOf("?")>-1){var l=i.split("?");o.url=l[0];var d=l[1].split("&");t.each(d,function(t,e){var n=e.split("=");o.data[n[0]]=n[1]})}else o.url=i;if(o.data[t(e).data("settings").queryParam]=n,o.type=t(e).data("settings").method,o.dataType=t(e).data("settings").contentType,t(e).data("settings").crossDomain&&(o.dataType="jsonp"),t(e).data("settings").excludeCurrent){var r=t(e).data("tokenInputObject").getTokens(),u=t.map(r,function(n){return"function"==typeof t(e).data("settings").tokenValue?t(e).data("settings").tokenValue.call(this,n):n[t(e).data("settings").tokenValue]});o.data[t(e).data("settings").excludeCurrentParameter]=u.join(t(e).data("settings").tokenDelimiter)}o.success=function(s){w.add(a,t(e).data("settings").jsonContainer?s[t(e).data("settings").jsonContainer]:s),t.isFunction(t(e).data("settings").onResult)&&(s=t(e).data("settings").onResult.call(x,s)),C.val()===n&&K(n,t(e).data("settings").jsonContainer?s[t(e).data("settings").jsonContainer]:s)},f.onSend&&f.onSend(o),f.searchFunction?f.searchFunction(o):t.ajax(o)}else if(t(e).data("settings").local_data){var c=t.grep(t(e).data("settings").local_data,function(a){return a[t(e).data("settings").propertyToSearch].toLowerCase().indexOf(n.toLowerCase())>-1});w.add(a,c),t.isFunction(t(e).data("settings").onResult)&&(c=t(e).data("settings").onResult.call(x,c)),K(n,c)}}(n)},t(e).data("settings").searchDelay)):W())}function Y(){var n=t(e).data("settings");return"function"==typeof n.url?n.url.call(n):n.url}function Z(t){setTimeout(function(){t.focus()},50)}},t.TokenList.Cache=function(e){var n,a,s={},i=0;n=t.extend({max_size:500},e),a=function(){s={},i=0},this.add=function(t,e){i>n.max_size&&a(),s[t]||(i+=1),s[t]=e},this.get=function(t){return s[t]}}}(jQuery);